apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: pgedge-private-schema
  labels:
    provider: postgresql
spec:
  compositeTypeRef:
    apiVersion: db.loa.kevinpthorne.com/v1alpha1
    kind: PrivateSchema
  mode: Pipeline
  pipeline:
    - step: patch-and-transform
      functionRef:
        name: function-patch-and-transform
      input:
        apiVersion: pt.fn.crossplane.io/v1beta1
        kind: Resources
        resources:
          # ------------------------------------------------------------------
          # 1. SQL ROLE (The User)
          # ------------------------------------------------------------------
          - name: pgedge-role
            base:
              apiVersion: postgresql.sql.crossplane.io/v1alpha1
              kind: Role
              metadata:
                name: PLACEHOLDER
              spec:
                providerConfigRef:
                  name: pgedge-provider-config
                forProvider:
                  privileges:
                    login: true
                    superUser: false
                    createDb: false
                    createRole: false
                    inherit: true
                  # No passwordSecretRef needed because we use Cert Auth
                  passwordSecretRef: null 
            patches:  
              - fromFieldPath: "spec.userName"
                toFieldPath: "spec.forProvider.name"
              - type: CombineFromComposite
                combine:
                  variables:
                  - fromFieldPath: spec.userName
                  strategy: string
                  string:
                    fmt: "pgedge-role-%s"
                toFieldPath: metadata.name
      
          # ------------------------------------------------------------------
          # 2. Client cert gen
          # ------------------------------------------------------------------
          - name: client-cert-gen
            base:
              apiVersion: cert-manager.io/v1
              kind: Certificate
              metadata:
                name: PLACEHOLDER
              spec:
                secretName: PLACEHOLDER
                usages:
                  - client auth
                commonName: admin
                issuerRef:
                  name: pgedge-{{ .Values.pgedge.appName }}-client-ca-issuer
                  kind: ClusterIssuer
                  group: cert-manager.io
                privateKey:
                  rotationPolicy: Never
            patches:
              - type: CombineFromComposite
                combine:
                  variables:
                  - fromFieldPath: spec.userName
                  strategy: string
                  string:
                    fmt: "pgedge-%s-client-cert"
                toFieldPath: metadata.name
              - type: CombineFromComposite
                combine:
                  variables:
                  - fromFieldPath: spec.userName
                  strategy: string
                  string:
                    fmt: "pgedge-%s-client-cert"
                toFieldPath: spec.secretName

          # ------------------------------------------------------------------
          # 3. SQL SCHEMA (The Container)
          # ------------------------------------------------------------------
          - name: pgedge-schema
            base:
              apiVersion: postgresql.sql.crossplane.io/v1alpha1
              kind: Schema
              spec:
                providerConfigRef:
                  name: pgedge-provider-config
            patches:
              - fromFieldPath: "spec.schemaName"
                toFieldPath: "spec.forProvider.name"
              - fromFieldPath: "spec.databaseName"
                toFieldPath: "spec.forProvider.database"
      
          # ------------------------------------------------------------------
          # 4. SQL GRANT (The Permission)
          # ------------------------------------------------------------------
          - name: pgedge-user-grant
            base:
              apiVersion: postgresql.sql.crossplane.io/v1alpha1
              kind: Grant
              spec:
                providerConfigRef:
                  name: pgedge-provider-config
                forProvider:
                  privileges: ["USAGE", "CREATE"]
                  objectType: SCHEMA
            patches:
              - fromFieldPath: "spec.userName"
                toFieldPath: "spec.forProvider.role"
              - fromFieldPath: "spec.databaseName"
                toFieldPath: "spec.forProvider.database"
              - fromFieldPath: "spec.schemaName"
                toFieldPath: "spec.forProvider.schema"
      
          # ------------------------------------------------------------------
          # 5. SQL GRANT (The Revocation - Security)
          # ------------------------------------------------------------------
          - name: pgedge-public-revoke
            base:
              apiVersion: postgresql.sql.crossplane.io/v1alpha1
              kind: Grant
              spec:
                providerConfigRef:
                  name: pgedge-provider-config
                forProvider:
                  role: PUBLIC
                  privileges: [] # Revoke all
                  objectType: SCHEMA
            patches:
              - fromFieldPath: "spec.databaseName"
                toFieldPath: "spec.forProvider.database"
              - fromFieldPath: "spec.schemaName"
                toFieldPath: "spec.forProvider.schema"
    - step: automatically-detect-readiness
      functionRef:
        name: function-auto-ready