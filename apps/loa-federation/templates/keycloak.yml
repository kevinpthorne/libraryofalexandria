apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: keycloak
  namespace: {{ .Values.argoNamespace }}
spec:
  project: default
  source:
    repoURL: https://charts.bitnami.com/bitnami
    chart: keycloak
    targetRevision: 25.2.x
    helm:
      values: |
        replicaCount: 2
        mode: ha
        
        # --- Security Context for Restricted Namespace ---
        
        # 1. Pod Level Security
        # We enforce the user ID and filesystem group to match Bitnami's non-root user (1001).
        # We also set the seccomp profile, which is mandatory for Restricted PSS.
        podSecurityContext:
          enabled: true
          fsGroup: 1001
          runAsUser: 1001
          runAsGroup: 1001
          runAsNonRoot: true
          seccompProfile:
            type: RuntimeDefault

        # 2. Container Level Security
        # We drop all capabilities and prevent privilege escalation.
        containerSecurityContext:
          enabled: true
          runAsNonRoot: true
          runAsUser: 1001
          allowPrivilegeEscalation: false
          capabilities:
            drop: ["ALL"]
          # readOnlyRootFilesystem: true 
          # Note: If you enable readOnlyRootFilesystem, you must mount 
          # extra emptyDir volumes for /tmp and /opt/bitnami/keycloak/logs

        # --- Application Logic (Previous Config) ---

        postgresql:
          enabled: false
        externalDatabase:
          host: "pgedge-cluster-{{ .Values.cluster.name }}-data-rw.pgedge.svc.cluster.local"
          port: 5432
          user: "app"
          database: "app"
          password: ""

        extraEnvVars:
          # JDBC Cert Auth string
          - name: KC_DB_URL_PROPERTIES
            value: "?sslmode=verify-full&sslcert=/etc/x509/db-client/tls.crt&sslkey=/etc/x509/db-client/tls.key&sslrootcert=/etc/x509/db-client/ca.crt"

        extraVolumeMounts:
          - name: db-client-certs
            mountPath: /etc/x509/db-client
            readOnly: true

        extraVolumes:
          - name: db-client-certs
            secret:
              secretName: app-client-cert
              defaultMode: 0400 

        tls:
          enabled: true
          autoGenerated: true
          existingIssuerKind: ClusterIssuer
          existingIssuer: pki-bootstrap

        service:
          type: ClusterIP
          ports:
            http: 80
            https: 443

        ingress:
          enabled: true
          hostname: idp.{{ .Values.cluster.name }}.loa.internal
          annotations:
            nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"

  destination:
    server: https://kubernetes.default.svc
    namespace: keycloak
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true